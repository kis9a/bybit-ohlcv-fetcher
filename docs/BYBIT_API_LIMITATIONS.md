# Bybit API 制限事項と注意事項

このドキュメントは、Bybit APIを使用してOHLCVデータを取得する際の制限事項と注意点をまとめたものです。

---

## 1. API制限の概要

### APIキーなしでのデータ取得

**重要**: OHLCVデータ（マーケットデータ）は **完全に公開API** です。

✅ **APIキーなしで取得可能**
- `Get Kline` エンドポイント（`fetchOHLCV`）は公開API
- APIキーの有無で履歴データの取得範囲は変わらない
- 認証不要で過去データにアクセス可能

⚠️ **1リクエストあたりの制限**
- **最大 1000本 / 1リクエスト**（Bybit側仕様）
- デフォルトは200本
- この制限はAPIキーの有無に関わらず適用される

参考: [Bybit API - Get Kline](https://bybit-exchange.github.io/docs/v5/market/kline)

---

## 2. データ取得本数と必要なリクエスト数

### 期間ごとの必要リクエスト数（limit=1000の場合）

| 時間足 | 1日の本数 | 6ヶ月の本数 | 必要なリクエスト数 |
|--------|----------|------------|------------------|
| **1m** | 1,440 | 259,200 | **260回** |
| **5m** | 288 | 51,840 | **52回** |
| **15m** | 96 | 17,280 | **18回** |
| **1h** | 24 | 4,320 | **5回** |
| **4h** | 6 | 1,080 | **2回** |
| **1d** | 1 | 180 | **1回** |

### 計算式

```
総データポイント数 = 期間(日) × 86400秒 / 時間足(秒)
必要なリクエスト数 = ceil(総データポイント数 / limit)
```

### 実例

```bash
# 1時間足で6ヶ月間
期間: 180日
時間足: 3600秒
総ポイント: 180 × 24 = 4,320本
リクエスト数: 5回

# 1分足で6ヶ月間
期間: 180日
時間足: 60秒
総ポイント: 180 × 1440 = 259,200本
リクエスト数: 260回
```

---

## 3. レートリミット（Rate Limit）

### グローバル（IP単位）制限

Bybit APIには **IP単位のレート制限** があります：

| 種別 | 制限値 | 超過時の対応 |
|------|--------|------------|
| **HTTP総数** | 600リクエスト / 5秒 / IP | `403 access too frequent`<br>約10分間のBAN |
| **WebSocket接続** | 500接続 / 5分<br>最大1000接続 / IP | 自動切断 |

参考: [Bybit API - Rate Limit Rules](https://bybit-exchange.github.io/docs/v5/rate-limit)

### エンドポイント別制限

一般的なレート制限の目安：

| エンドポイント種別 | 制限 |
|------------------|------|
| Market Data (OHLCV等) | 120リクエスト/分 |
| Order Management | 60リクエスト/分 |
| Position Queries | 120リクエスト/分 |

### 推奨事項

1. **リクエスト間に待機時間を設ける**
   - 推奨: 2秒以上（デフォルト設定）
   - より安全: 3〜5秒
   - `fetch_ohlcv.sh`の`-d`オプションで調整可能

2. **エラー時のリトライ処理**
   - `429 Too Many Requests` または `403 Forbidden` を検出
   - 指数バックオフ（exponential backoff）で再試行
   - 最大3回程度でリトライを打ち切る

3. **大量データ取得時の配慮**
   ```bash
   # 1分足で6ヶ月（260回のリクエスト）の場合
   # 2秒待機 × 260回 = 約9分の取得時間
   # 5秒待機なら約22分

   ./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 6months -d 5
   ```

---

## 4. データ取得可能な期間

### 履歴データの範囲

**上限**: 各シンボルの **上場日（launchTime）まで**

例: `BTCUSDT`（線形無期限）
- 上場日: 2020-03-30頃
- この日以降のデータは全て取得可能

参考: [Bybit API - Get Instruments Info](https://bybit-exchange.github.io/docs/v5/market/instrument)

### 取得方法

ページネーションを使用して繰り返し取得すれば、理論上全期間のデータを取得可能。

```bash
# 3年分のデータ取得（約26,000本 = 26回のリクエスト）
./fetch_ohlcv.sh -s "BTC/USDT" -t 1h -p 3years
```

---

## 5. 利用規約・ポリシー上の注意点

### 許可される用途

✅ **個人的なバックテスト・研究**
- 自分のトレード戦略の検証
- ディープラーニングモデルの学習
- アルゴリズムトレーディングボットの開発

✅ **自動売買ボット運用**
- 裁定取引（アービトラージ）
- マーケットメイキング
- 一般的なトレーディングアルゴリズム

### 禁止される行為

❌ **データの商用再配布・販売**
- 取得したマーケットデータを第三者に販売・提供
- データ配信サービスの運営
- ※ 事前にBybitとの契約が必要

❌ **プラットフォームへの過度な負荷**
- レート制限を無視した大量リクエスト
- 意図的なサーバー負荷の増大

❌ **バグや仕様の悪用**
- システムの脆弱性を突いた不正行為
- 価格操作を目的とした悪質なボット

❌ **規制違反・マネーロンダリング**
- KYC/AML規制の回避
- 禁止地域からのアクセス

### ペナルティ

規約違反時の対応：
- IPアドレスのブロック（一時的 or 永久）
- アカウントの凍結・停止
- 法的措置（悪質な場合）

---

## 6. 安全に使うためのベストプラクティス

### 実装レベル

1. **レート制限を遵守する**
   ```bash
   # 推奨: 2〜5秒の待機時間
   ./fetch_ohlcv.sh -s "BTC/USDT" -t 5m -p 30days -d 3
   ```

2. **エラーハンドリングを実装する**
   - HTTPステータスコードを確認
   - `403`, `429`の場合はバックオフして再試行
   - レスポンスヘッダーの`X-RateLimit-*`を活用

3. **ログを記録する**
   - API呼び出し回数
   - エラー発生時の詳細
   - データ取得の成功/失敗

### 利用方針

1. **データ用途は個人利用に限定**
   - バックテスト
   - 戦略開発
   - 研究目的

2. **商用利用時は確認する**
   - Bybit公式に問い合わせ
   - 必要に応じてAPI利用契約を締結

3. **規約を定期的に確認する**
   - [Bybit Terms of Service](https://www.bybit.com/en-US/terms-service/terms-of-use)
   - [Bybit API Terms](https://bybit-exchange.github.io/docs/)

---

## 7. トレーディング粒度別の推奨設定

| 粒度 | よく使われる用途 | 注意ポイント | 推奨設定 |
|------|----------------|------------|----------|
| **Tick（注文/約定単位）** | HFT、マーケットメイキング、Orderbook学習 | データ量膨大、取得コスト高 | 別途対応必要 |
| **1秒〜1分** | スキャルピング、短期予測LSTM | 約定遅延・スリッページ再現 | `-t 1m -p 7days`<br>1週間で10,080本 |
| **1分〜5分**（最も一般的） | 短期〜中期DL、Crypto/FX bot | 学習・バックテストバランス◎ | `-t 5m -p 3months`<br>3ヶ月で25,920本 |
| **15分〜1時間** | 中期トレンドCNN/LSTM | 高頻度要素の表現弱 | `-t 1h -p 6months`<br>6ヶ月で4,320本 |
| **日足（Daily）** | ファクターモデル、長期投資 | ML/DLメリット薄 | `-t 1d -p 3years`<br>3年で1,095本 |

### 具体例

```bash
# スキャルピングbot: 1分足 1週間
./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 7days -d 2

# デイトレードbot: 5分足 3ヶ月
./fetch_ohlcv.sh -s "BTC/USDT" -t 5m -p 3months -d 2

# スイングトレードbot: 1時間足 1年
./fetch_ohlcv.sh -s "BTC/USDT" -t 1h -p 1year -d 2

# 長期投資: 1日足 5年
./fetch_ohlcv.sh -s "BTC/USDT" -t 1d -p 5years -d 2
```

---

## 8. 市場タイプ（Market Types）

Bybitでは3つの主要な市場タイプをサポートしており、それぞれ異なる特性とユースケースがあります。

### 8.1 市場タイプの概要

#### Spot（現物市場）

**概要**: 実際の暗号通貨を即座に売買する市場

**特徴**:
- 決済通貨: 取引ペアに応じた実際の暗号通貨
- レバレッジ: 基本的になし（マージン取引を除く）
- 有効期限: なし
- 損益計算: シンプル（実際の資産価格変動）
- ファンディングレート: なし
- シンボル表記: `BTC/USDT`, `ETH/USDT`

**適したユースケース**:
- 長期保有（HODLing）
- 実際の暗号通貨の所有
- シンプルな投資戦略
- スポット価格での売買

#### Linear（USDT建て無期限契約）

**概要**: USDTを証拠金として使用する無期限先物契約

**特徴**:
- 決済通貨: USDT（テザー）
- レバレッジ: 利用可能（取引ペアにより異なる）
- 有効期限: なし（無期限契約）
- 損益計算: シンプル（USDT建て）
- ファンディングレート: あり
- シンボル表記: `BTC/USDT`, `ETH/USDT`（市場タイプ指定必須）

**適したユースケース**:
- レバレッジ取引
- USDTベースの資産管理
- 基礎資産の価格変動リスクからの分離
- 直感的な損益管理

#### Inverse（BTC建て無期限契約）

**概要**: BTCまたは他の暗号通貨を証拠金として使用する無期限先物契約

**特徴**:
- 決済通貨: BTC（または基礎資産）
- レバレッジ: 利用可能
- 有効期限: なし（無期限契約）
- 損益計算: 複雑（逆転価格特性）
- ファンディングレート: あり
- シンボル表記: `BTC/USD`, `ETH/USD`

**適したユースケース**:
- 暗号通貨の蓄積（BTCを稼ぐ）
- 暗号通貨保有のヘッジ
- 担保資産の市場リスクを許容できる場合

### 8.2 市場タイプ別のデータ特性

#### データ取得の違い

各市場タイプでは、同じシンボルでも異なるデータが取得されます：

| 市場タイプ | データソース | 価格基準 | 流動性 |
|---------|-----------|---------|-------|
| **Spot** | 現物取引所 | 実際の売買価格 | 中〜高 |
| **Linear** | USDT建て先物 | 先物価格（USDT建て） | 最高 |
| **Inverse** | BTC建て先物 | 先物価格（BTC建て） | 中 |

#### 取引量の違い

一般的に、Linear契約（USDT建て無期限）が最も高い取引量を持ちます：

```
取引量の傾向:
Linear > Spot > Inverse
```

**理由**:
- Linear契約はUSDT建てで直感的
- 多くのトレーダーがレバレッジ取引を好む
- 機関投資家の参加が多い

### 8.3 シンボル表記の注意点

#### Spot市場

```bash
# 正しい表記
./ohlcv -symbol "BTC/USDT" -market spot
./ohlcv -symbol "ETH/USDT" -market spot

# 主要なSpotペア
BTC/USDT, ETH/USDT, LTC/USDT, XRP/USDT
```

#### Linear契約

```bash
# 正しい表記（USDT建て）
./ohlcv -symbol "BTC/USDT" -market linear
./ohlcv -symbol "ETH/USDT" -market linear

# 注意: シンボル形式はSpotと同じだが、市場タイプが異なる
# 内部的にはCCXTが "BTC/USDT:USDT" として処理
```

#### Inverse契約

```bash
# 正しい表記（USD建て）
./ohlcv -symbol "BTC/USD" -market inverse
./ohlcv -symbol "ETH/USD" -market inverse

# 注意: クォート通貨がUSDTではなくUSD
```

### 8.4 市場タイプ選択のベストプラクティス

#### バックテスト用途

| 戦略タイプ | 推奨市場 | 理由 |
|----------|---------|------|
| 長期投資 | Spot | 実際の資産価格を反映 |
| デイトレード | Linear | 高流動性、シンプルな計算 |
| スキャルピング | Linear | 最高の流動性とスプレッド |
| 暗号通貨蓄積 | Inverse | BTCベースの損益 |
| アービトラージ | Spot + Linear | 価格差を利用 |

#### ディープラーニング用途

```bash
# 推奨: Linear契約（最高の流動性とデータ品質）
./scripts/fetch_ohlcv.sh -s "BTC/USDT" -m linear -t 5m -p 6months

# 補助: Spotデータで検証
./scripts/fetch_ohlcv.sh -s "BTC/USDT" -m spot -t 5m -p 6months
```

**理由**:
- Linear契約は取引量が最大
- ノイズが少なく、パターン認識に適している
- 24時間365日の連続データ

#### 注意事項

1. **価格の乖離**: Spot価格と先物価格には差がある
   - ファンディングレートによる影響
   - 需給バランスの違い
   - プレミアム/ディスカウント

2. **データの一貫性**: 同じシンボルでも市場タイプで異なる
   ```bash
   # これらは異なるデータを返す
   ./ohlcv -symbol "BTC/USDT" -market spot
   ./ohlcv -symbol "BTC/USDT" -market linear
   ```

3. **流動性の確認**: マイナーなアルトコインは市場タイプによって流動性が大きく異なる

### 8.5 市場タイプとシンボルの対応表

| 市場タイプ | シンボル例 | CCXTでの内部表記 | 決済通貨 |
|---------|----------|----------------|---------|
| Spot | `BTC/USDT` | `BTC/USDT` | USDT |
| Spot | `ETH/USDT` | `ETH/USDT` | USDT |
| Linear | `BTC/USDT` | `BTC/USDT:USDT` | USDT |
| Linear | `ETH/USDT` | `ETH/USDT:USDT` | USDT |
| Inverse | `BTC/USD` | `BTC/USD:BTC` | BTC |
| Inverse | `ETH/USD` | `ETH/USD:ETH` | ETH |

**重要**:
- SpotとLinearは同じシンボル表記を使用しますが、`-market`オプションで区別されます
- CCXTライブラリが内部的に適切な形式に変換します
- Inverseは異なるクォート通貨（USD）を使用します

---

## 9. よくある質問（FAQ）

### Q1: APIキーは本当に不要ですか？
**A**: はい。OHLCVデータ（マーケットデータ）の取得には **APIキー不要** です。ただし、将来的にプライベートAPI（残高照会、注文実行等）を使う場合は必要になります。

### Q2: レート制限を超えるとどうなりますか？
**A**: `403 Forbidden` または `429 Too Many Requests` が返され、約10分間IPがブロックされます。ブロック中はAPIアクセスができません。

### Q3: 1分足で1年分のデータを取得できますか？
**A**: 可能です。ただし、約525,600本のデータとなり、526回のAPIリクエストが必要です（待機時間2秒で約18分）。

```bash
./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 1year -d 2
```

### Q4: データを商用利用できますか？
**A**: 個人のバックテスト目的なら問題ありません。ただし、**データの再配布・販売はBybitとの事前契約が必要**です。

### Q5: WebSocketでデータ取得した方が良いですか？
**A**: リアルタイムデータならWebSocketが最適です。しかし、**過去データの一括取得にはREST API（現在の方法）が適しています**。

### Q6: どの市場タイプを選ぶべきですか？
**A**: 用途によって異なります：
- **バックテスト/機械学習**: Linear契約（最高の流動性とデータ品質）
- **現物保有シミュレーション**: Spot市場
- **BTCベースの損益管理**: Inverse契約

### Q7: SpotとLinearで同じシンボル（BTC/USDT）を使えますか？
**A**: はい、使えます。`-market`オプションで市場タイプを指定してください：
```bash
# Spot市場
./ohlcv -symbol "BTC/USDT" -market spot

# Linear契約
./ohlcv -symbol "BTC/USDT" -market linear
```

### Q8: 市場タイプによって価格は異なりますか？
**A**: はい、わずかに異なります。Spot価格と先物価格にはプレミアムやディスカウントが発生する場合があります。これはファンディングレートや需給バランスの違いによるものです。

---

## 10. 参考リンク

- [Bybit API ドキュメント](https://bybit-exchange.github.io/docs/)
- [Get Kline (OHLCV)](https://bybit-exchange.github.io/docs/v5/market/kline)
- [Rate Limit Rules](https://bybit-exchange.github.io/docs/v5/rate-limit)
- [Get Instruments Info](https://bybit-exchange.github.io/docs/v5/market/instrument)
- [Bybit Terms of Service](https://www.bybit.com/en-US/terms-service/terms-of-use)

---

## 11. 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-04 | 市場タイプ（Spot/Linear/Inverse）の説明を追加 |
| 2025-12-04 | 初版作成 |

---

**注意**: Bybit APIの仕様は変更される可能性があります。実装前に必ず最新の公式ドキュメントを確認してください。
