# Bybit API 制限事項と注意事項

このドキュメントは、Bybit APIを使用してOHLCVデータを取得する際の制限事項と注意点をまとめたものです。

---

## 1. API制限の概要

### APIキーなしでのデータ取得

**重要**: OHLCVデータ（マーケットデータ）は **完全に公開API** です。

✅ **APIキーなしで取得可能**
- `Get Kline` エンドポイント（`fetchOHLCV`）は公開API
- APIキーの有無で履歴データの取得範囲は変わらない
- 認証不要で過去データにアクセス可能

⚠️ **1リクエストあたりの制限**
- **最大 1000本 / 1リクエスト**（Bybit側仕様）
- デフォルトは200本
- この制限はAPIキーの有無に関わらず適用される

参考: [Bybit API - Get Kline](https://bybit-exchange.github.io/docs/v5/market/kline)

---

## 2. データ取得本数と必要なリクエスト数

### 期間ごとの必要リクエスト数（limit=1000の場合）

| 時間足 | 1日の本数 | 6ヶ月の本数 | 必要なリクエスト数 |
|--------|----------|------------|------------------|
| **1m** | 1,440 | 259,200 | **260回** |
| **5m** | 288 | 51,840 | **52回** |
| **15m** | 96 | 17,280 | **18回** |
| **1h** | 24 | 4,320 | **5回** |
| **4h** | 6 | 1,080 | **2回** |
| **1d** | 1 | 180 | **1回** |

### 計算式

```
総データポイント数 = 期間(日) × 86400秒 / 時間足(秒)
必要なリクエスト数 = ceil(総データポイント数 / limit)
```

### 実例

```bash
# 1時間足で6ヶ月間
期間: 180日
時間足: 3600秒
総ポイント: 180 × 24 = 4,320本
リクエスト数: 5回

# 1分足で6ヶ月間
期間: 180日
時間足: 60秒
総ポイント: 180 × 1440 = 259,200本
リクエスト数: 260回
```

---

## 3. レートリミット（Rate Limit）

### グローバル（IP単位）制限

Bybit APIには **IP単位のレート制限** があります：

| 種別 | 制限値 | 超過時の対応 |
|------|--------|------------|
| **HTTP総数** | 600リクエスト / 5秒 / IP | `403 access too frequent`<br>約10分間のBAN |
| **WebSocket接続** | 500接続 / 5分<br>最大1000接続 / IP | 自動切断 |

参考: [Bybit API - Rate Limit Rules](https://bybit-exchange.github.io/docs/v5/rate-limit)

### エンドポイント別制限

一般的なレート制限の目安：

| エンドポイント種別 | 制限 |
|------------------|------|
| Market Data (OHLCV等) | 120リクエスト/分 |
| Order Management | 60リクエスト/分 |
| Position Queries | 120リクエスト/分 |

### 推奨事項

1. **リクエスト間に待機時間を設ける**
   - 推奨: 2秒以上（デフォルト設定）
   - より安全: 3〜5秒
   - `fetch_ohlcv.sh`の`-d`オプションで調整可能

2. **エラー時のリトライ処理**
   - `429 Too Many Requests` または `403 Forbidden` を検出
   - 指数バックオフ（exponential backoff）で再試行
   - 最大3回程度でリトライを打ち切る

3. **大量データ取得時の配慮**
   ```bash
   # 1分足で6ヶ月（260回のリクエスト）の場合
   # 2秒待機 × 260回 = 約9分の取得時間
   # 5秒待機なら約22分

   ./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 6months -d 5
   ```

---

## 4. データ取得可能な期間

### 履歴データの範囲

**上限**: 各シンボルの **上場日（launchTime）まで**

例: `BTCUSDT`（線形無期限）
- 上場日: 2020-03-30頃
- この日以降のデータは全て取得可能

参考: [Bybit API - Get Instruments Info](https://bybit-exchange.github.io/docs/v5/market/instrument)

### 取得方法

ページネーションを使用して繰り返し取得すれば、理論上全期間のデータを取得可能。

```bash
# 3年分のデータ取得（約26,000本 = 26回のリクエスト）
./fetch_ohlcv.sh -s "BTC/USDT" -t 1h -p 3years
```

---

## 5. 利用規約・ポリシー上の注意点

### 許可される用途

✅ **個人的なバックテスト・研究**
- 自分のトレード戦略の検証
- ディープラーニングモデルの学習
- アルゴリズムトレーディングボットの開発

✅ **自動売買ボット運用**
- 裁定取引（アービトラージ）
- マーケットメイキング
- 一般的なトレーディングアルゴリズム

### 禁止される行為

❌ **データの商用再配布・販売**
- 取得したマーケットデータを第三者に販売・提供
- データ配信サービスの運営
- ※ 事前にBybitとの契約が必要

❌ **プラットフォームへの過度な負荷**
- レート制限を無視した大量リクエスト
- 意図的なサーバー負荷の増大

❌ **バグや仕様の悪用**
- システムの脆弱性を突いた不正行為
- 価格操作を目的とした悪質なボット

❌ **規制違反・マネーロンダリング**
- KYC/AML規制の回避
- 禁止地域からのアクセス

### ペナルティ

規約違反時の対応：
- IPアドレスのブロック（一時的 or 永久）
- アカウントの凍結・停止
- 法的措置（悪質な場合）

---

## 6. 安全に使うためのベストプラクティス

### 実装レベル

1. **レート制限を遵守する**
   ```bash
   # 推奨: 2〜5秒の待機時間
   ./fetch_ohlcv.sh -s "BTC/USDT" -t 5m -p 30days -d 3
   ```

2. **エラーハンドリングを実装する**
   - HTTPステータスコードを確認
   - `403`, `429`の場合はバックオフして再試行
   - レスポンスヘッダーの`X-RateLimit-*`を活用

3. **ログを記録する**
   - API呼び出し回数
   - エラー発生時の詳細
   - データ取得の成功/失敗

### 利用方針

1. **データ用途は個人利用に限定**
   - バックテスト
   - 戦略開発
   - 研究目的

2. **商用利用時は確認する**
   - Bybit公式に問い合わせ
   - 必要に応じてAPI利用契約を締結

3. **規約を定期的に確認する**
   - [Bybit Terms of Service](https://www.bybit.com/en-US/terms-service/terms-of-use)
   - [Bybit API Terms](https://bybit-exchange.github.io/docs/)

---

## 7. トレーディング粒度別の推奨設定

| 粒度 | よく使われる用途 | 注意ポイント | 推奨設定 |
|------|----------------|------------|----------|
| **Tick（注文/約定単位）** | HFT、マーケットメイキング、Orderbook学習 | データ量膨大、取得コスト高 | 別途対応必要 |
| **1秒〜1分** | スキャルピング、短期予測LSTM | 約定遅延・スリッページ再現 | `-t 1m -p 7days`<br>1週間で10,080本 |
| **1分〜5分**（最も一般的） | 短期〜中期DL、Crypto/FX bot | 学習・バックテストバランス◎ | `-t 5m -p 3months`<br>3ヶ月で25,920本 |
| **15分〜1時間** | 中期トレンドCNN/LSTM | 高頻度要素の表現弱 | `-t 1h -p 6months`<br>6ヶ月で4,320本 |
| **日足（Daily）** | ファクターモデル、長期投資 | ML/DLメリット薄 | `-t 1d -p 3years`<br>3年で1,095本 |

### 具体例

```bash
# スキャルピングbot: 1分足 1週間
./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 7days -d 2

# デイトレードbot: 5分足 3ヶ月
./fetch_ohlcv.sh -s "BTC/USDT" -t 5m -p 3months -d 2

# スイングトレードbot: 1時間足 1年
./fetch_ohlcv.sh -s "BTC/USDT" -t 1h -p 1year -d 2

# 長期投資: 1日足 5年
./fetch_ohlcv.sh -s "BTC/USDT" -t 1d -p 5years -d 2
```

---

## 8. よくある質問（FAQ）

### Q1: APIキーは本当に不要ですか？
**A**: はい。OHLCVデータ（マーケットデータ）の取得には **APIキー不要** です。ただし、将来的にプライベートAPI（残高照会、注文実行等）を使う場合は必要になります。

### Q2: レート制限を超えるとどうなりますか？
**A**: `403 Forbidden` または `429 Too Many Requests` が返され、約10分間IPがブロックされます。ブロック中はAPIアクセスができません。

### Q3: 1分足で1年分のデータを取得できますか？
**A**: 可能です。ただし、約525,600本のデータとなり、526回のAPIリクエストが必要です（待機時間2秒で約18分）。

```bash
./fetch_ohlcv.sh -s "BTC/USDT" -t 1m -p 1year -d 2
```

### Q4: データを商用利用できますか？
**A**: 個人のバックテスト目的なら問題ありません。ただし、**データの再配布・販売はBybitとの事前契約が必要**です。

### Q5: WebSocketでデータ取得した方が良いですか？
**A**: リアルタイムデータならWebSocketが最適です。しかし、**過去データの一括取得にはREST API（現在の方法）が適しています**。

---

## 9. 参考リンク

- [Bybit API ドキュメント](https://bybit-exchange.github.io/docs/)
- [Get Kline (OHLCV)](https://bybit-exchange.github.io/docs/v5/market/kline)
- [Rate Limit Rules](https://bybit-exchange.github.io/docs/v5/rate-limit)
- [Get Instruments Info](https://bybit-exchange.github.io/docs/v5/market/instrument)
- [Bybit Terms of Service](https://www.bybit.com/en-US/terms-service/terms-of-use)

---

## 10. 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-04 | 初版作成 |

---

**注意**: Bybit APIの仕様は変更される可能性があります。実装前に必ず最新の公式ドキュメントを確認してください。
